---
**注意:** このドキュメントは `src/mcp_server.py` の機能について説明していますが、`document/permanent/` ディレクトリにあるドキュメント群ほど厳密なレビューを受けていない可能性があります。内容が古くなったり、不正確な記述が含まれる場合があるため、利用の際はご注意ください。最新の確定情報やプロジェクト全体の概要については、リポジトリルートの `README.md` および `document/permanent/` 内の各ドキュメントを参照することを推奨します。
---

# MCPサーバー利用マニュアル

## 1. 目的
`src/mcp_server.py` は、標準入出力（stdio）を介してMCP（Multi-Context Planner）プロトコルを使用し、外部プログラム（AIエージェントや他のプランニングツールなど）が本リポジトリのコアロジック（DP計算やシミュレーション）を利用できるようにするためのサーバーです。HTTPサーバーではなく、より軽量なプロセス間通信の仕組みを採用しています。

## 2. サーバーの起動
リポジトリのルートディレクトリから以下のコマンドでサーバーを起動します。
```bash
python -m src.mcp_server
```
サーバーは標準入力からのJSONメッセージを待ち受け、結果を標準出力にJSONメッセージとして返します。

## 3. MCPプロトコルと通信形式
MCPサーバーとの通信は、JSON形式のメッセージを標準入力に送信し、標準出力からJSON形式の応答を受信することで行われます。

**初期化:**
サーバー起動後、クライアントはまずサーバーの能力に関する情報（利用可能なツールなど）を要求することがあります。

**ツール呼び出し:**
クライアントが特定のタスク（例: DP計算）を実行したい場合、ツール呼び出しリクエストを送信します。

**概念的な対話フロー:**
1.  クライアント: `list_tools` リクエストを送信 (MCPプロトコル標準)
2.  サーバー: 利用可能なツールのリスト (`calculate_dp`, `run_simulation`) を含むJSON応答を返す。
3.  クライアント: 例えば `calculate_dp` ツールを呼び出すためのJSONリクエストを送信。
4.  サーバー: `calculate_dp` を実行し、結果をJSONで返す。

## 4. 利用可能なツール
サーバーは以下のツールを提供します。

### 4.1 `calculate_dp`
動的プログラミング（DP）を用いて、指定された条件下での最終レートの期待値と最適行動を計算します。

**パラメータ:**
*   `n_matches` (整数, 必須): 残り試合数。0以上の整数。
*   `accounts` (整数, オプション, デフォルト: `2`): アカウント数。1以上の整数。
*   `initial_ratings` (数値の配列, オプション): 各アカウントの初期レート（浮動小数点数）のリスト。指定する場合、要素数は `accounts` と一致する必要があります。省略時は全アカウントが `mu` (適正レート)で初期化されます。
*   `rating_step` (数値, オプション, デフォルト: `16`): 1試合あたりのレート変動幅。
*   `k_coeff` (数値, オプション, デフォルト: `log(10)/1600`): 勝率計算のための係数。
*   `mu` (数値, オプション, デフォルト: `1500.0`): プレイヤーの適正レート。

**リクエスト例 (概念):**
```json
{
  "type": "call_tool",
  "id": "request-1",
  "tool": "calculate_dp",
  "arguments": {
    "n_matches": 10,
    "accounts": 2,
    "initial_ratings": [1500.0, 1520.0],
    "mu": 1500.0
  }
}
```

**レスポンス例 (概念):**
```json
{
  "type": "tool_response",
  "id": "request-1",
  "tool_name": "calculate_dp",
  "content": [
    {
      "type": "text",
      "text": "動的プログラミング計算結果:\n\n試合数: 10\nアカウント数: 2\n初期状態: [1500.0, 1520.0]\n\n期待値: 1525 (整数表現: ...)\n最適行動: アカウント 1 を選択\n"
    }
  ]
}
```
*(注意: 実際のレスポンス形式はMCPプロトコルに準拠し、`text` フィールドの内容は `src/mcp_server.py` の `handle_calculate_dp` 関数によって生成される文字列となります。)*

### 4.2 `run_simulation`
指定されたポリシーに基づいてモンテカルロシミュレーションを実行し、複数のエピソードにおける最終レートの分布などを評価します。

**パラメータ:**
*   `n_matches` (整数, 必須): 最大試合数。0以上の整数。
*   `accounts` (整数, オプション, デフォルト: `2`): アカウント数。1以上の整数。
*   `initial_ratings` (数値の配列, オプション): 各アカウントの初期レート（浮動小数点数）のリスト。省略時は全アカウントが `mu` で初期化。
*   `episodes` (整数, オプション, デフォルト: `1000`): シミュレーションするエピソード数。1以上の整数。
*   `policy` (文字列, オプション, デフォルト: `"all"`): 使用するポリシー。有効な値は `"optimal"`, `"random"`, `"fixed"`, `"greedy"`, `"all"`。
*   `fixed_idx` (整数, オプション, デフォルト: `0`): `policy` が `"fixed"` の場合に選択するアカウントのインデックス。0以上かつ `accounts` 未満。
*   `rating_step` (数値, オプション, デフォルト: `16`): レート変動幅。
*   `k_coeff` (数値, オプション, デフォルト: `log(10)/1600`): 勝率係数。
*   `mu` (数値, オプション, デフォルト: `1500.0`): 適正レート。

**リクエスト例 (概念):**
```json
{
  "type": "call_tool",
  "id": "request-2",
  "tool": "run_simulation",
  "arguments": {
    "n_matches": 20,
    "accounts": 2,
    "initial_ratings": [1480.0, 1500.0],
    "episodes": 100,
    "policy": "greedy"
  }
}
```

**レスポンス例 (概念):**
```json
{
  "type": "tool_response",
  "id": "request-2",
  "tool_name": "run_simulation",
  "content": [
    {
      "type": "text",
      "text": "シミュレーション結果:\n\n試合数: 20\nアカウント数: 2\nエピソード数: 100\nポリシー: greedy\n初期状態: [1480.0, 1500.0]\n\nGreedyPolicy:\n  平均最終レーティング: 1510.50\n  標準偏差: 25.30\n"
    }
  ]
}
```
*(注意: 実際のレスポンス形式はMCPプロトコルに準拠し、`text` フィールドの内容は `src/mcp_server.py` の `handle_run_simulation` 関数によって生成される文字列となります。可視化オプションはMCPサーバー経由では直接サポートされていません。)*
