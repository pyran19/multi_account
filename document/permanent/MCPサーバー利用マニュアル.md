# MCPサーバー利用マニュアル

## 1. 目的
`src/mcp_server.py` は、標準入出力（stdio）を介してMCP（Model Context Protocol）プロトコルを使用し、外部プログラム（AIエージェントや他のプランニングツールなど）が本リポジトリのコアロジック（DP計算やシミュレーション）を利用できるようにするためのサーバーです。HTTPサーバーではなく、プロセス間通信を採用しています。

## 2. サーバーの起動
リポジトリのルートディレクトリから以下のコマンドでサーバーを起動します。

**uvを使用する場合（推奨）:**
```bash
export PYTHONPATH=$PYTHONPATH:.
uv run src/mcp_server.py
```

**標準のPythonを使用する場合:**
```bash
export PYTHONPATH=$PYTHONPATH:.
python -m src.mcp_server
```

サーバーは標準入力からのJSONメッセージを待ち受け、結果を標準出力にJSONメッセージとして返します。

## 3. MCPプロトコルと通信形式
MCPサーバーとの通信は、JSON形式のメッセージを標準入力に送信し、標準出力からJSON形式の応答を受信することで行われます。

**初期化:**
サーバー起動後、クライアントはまず `list_tools` リクエストを送信してサーバーの能力（利用可能なツール）に関する情報を取得します。

**ツール呼び出し:**
クライアントが特定のタスク（例: DP計算）を実行したい場合、`call_tool` リクエストを送信します。

## 4. 利用可能なツール
サーバーは以下の2つのツールを提供します。

### 4.1 `calculate_dp`
動的プログラミング（DP）を用いて、指定された条件下での最終レートの期待値と最適行動を計算します。

**パラメータ:**
- `n_matches` (整数, 必須): 試合数。0以上の整数。
- `accounts` (整数, オプション, デフォルト: `2`): アカウント数。1以上の整数。
- `initial_ratings` (数値の配列, オプション): 各アカウントの初期レート（浮動小数点数）のリスト。指定する場合、要素数は `accounts` と一致する必要があります。省略時は全アカウントが1500で初期化されます。
- `rating_step` (数値, オプション, デフォルト: `16`): レーティングステップ。1試合あたりのレート変動幅。
- `k_coeff` (数値, オプション, デフォルト: `log(10)/1600`): Kファクター係数。勝率計算のための係数。
- `mu` (数値, オプション, デフォルト: `1500.0`): 平均レーティング。プレイヤーの適正レート。

**出力形式:**
```
動的プログラミング計算結果:

試合数: {n_matches}
アカウント数: {num_accounts}
初期状態: {整数レートのリスト}

期待値: {expected_value_int}
最適行動: アカウント {best_action_account_index} を選択
```

### 4.2 `run_simulation`
指定されたポリシーに基づいてモンテカルロシミュレーションを実行し、複数のエピソードにおける最終レートの分布などを評価します。

**パラメータ:**
- `n_matches` (整数, 必須): 試合数。0以上の整数。
- `accounts` (整数, オプション, デフォルト: `2`): アカウント数。1以上の整数。
- `initial_ratings` (数値の配列, オプション): 各アカウントの初期レート（浮動小数点数）のリスト。省略時は全アカウントが1500で初期化されます。
- `episodes` (整数, オプション, デフォルト: `1000`): エピソード数。シミュレーションするエピソード数。1以上の整数。
- `policy` (文字列, オプション, デフォルト: `"all"`): 使用するポリシー。有効な値は `"optimal"`, `"random"`, `"fixed"`, `"greedy"`, `"all"`。
- `fixed_idx` (整数, オプション, デフォルト: `0`): `policy` が `"fixed"` の場合に選択するアカウントのインデックス。0以上かつ `accounts` 未満。
- `rating_step` (数値, オプション, デフォルト: `16`): レーティングステップ。
- `k_coeff` (数値, オプション, デフォルト: `log(10)/1600`): Kファクター係数。
- `mu` (数値, オプション, デフォルト: `1500.0`): 平均レーティング。

**出力形式:**
```
シミュレーション結果:

試合数: {n_matches}
アカウント数: {num_accounts}
エピソード数: {episodes}
ポリシー: {policy_name}
初期状態: {整数レートのリスト}

{policy_name}:
  平均最終レーティング: {mean_final_rating:.2f}
  標準偏差: {std_final_rating:.2f}
```

**ポリシーについて:**
- `optimal`: 最適ポリシー（DP計算に基づく）
- `random`: ランダムにアカウントを選択
- `fixed`: 常に指定されたアカウント（`fixed_idx`）を選択
- `greedy`: 現在最もレートが高いアカウントを選択
- `all`: 複数のポリシー（random, fixed, greedy）を比較

注意: MCPサーバー経由では可視化機能はサポートされていません。

## 5. エラーハンドリング
ツール実行時にエラーが発生した場合、以下の形式でエラーメッセージが返されます：
```
エラーが発生しました: {エラーの詳細}
```

## 6. 実装の詳細
- サーバー名: `"multi-account-simulator"`
- サーバーバージョン: `"0.1.0"`
- 入力検証: MCPプロトコルのスキーマに基づいて自動的に行われます
- 内部処理: `src.cli` モジュールの `perform_dp_calculation` および `perform_simulation` 関数を使用 