# 整数レート計算

本ファイルでは、プロジェクトで採用している整数レート表現と計算方法について詳細に解説する。

## 1. 概要

実数レートを自由に動かすと、微小な数値誤差によって同一状態が異なると判断されたり、キャッシュが効かなくなるなどの問題がある。また、勝ちor負けのレート変動幅が固定値（例: ±16）であることを考慮すると、レートを整数値に制限することで計算効率と安定性を向上できる。

## 2. 変換方法

### 2.1 実数レート → 整数レート

実数レート `r` から整数レート `i` への変換:

```
i = round((r - μ) / d)
```

ここで：
- `r`: 実数レート（例: 1500、1516、1484）
- `μ`: 適正レート（デフォルト 1500）
- `d`: レート変動幅（デフォルト 16）

例えば：
- 1500 → 0 (適正レート)
- 1516 → 1 (1勝)
- 1484 → -1 (1敗)

### 2.2 整数レート → 実数レート

整数レート `i` から実数レート `r` への変換:

```
r = μ + i * d
```

## 3. 内部表現

### 3.1 State クラス

`State` クラスは内部的に整数レートの `Tuple` を保持する。API からは以下の方法でアクセスできる：

- `state.ratings`: 整数レートのタプル
- `state.float_ratings`: 実数レートのタプル（内部で変換）
- `state.best`: 最大整数レート
- `state.best_float`: 最大実数レート（内部で変換）

### 3.2 期待値計算

`dp.py` の内部計算では、整数レートのみを使用し、計算速度とメモリ効率を向上させている：

- `_expectation_cached()`: 整数レートで計算し、整数レートの期待値を返す
- `expectation()`: 公開 API として、実数レートの期待値を返す（内部で変換）

### 3.3 レート変化

試合の勝敗による状態遷移も整数レートベースで実装：

- 勝利時: `rating += 1`（整数レートの場合は常に +1）
- 敗北時: `rating -= 1`（整数レートの場合は常に -1）

## 4. 境界インターフェース

- ユーザー入出力: 常に実数レート
- 内部計算: 常に整数レート
- 永続化（キャッシュ）: 整数レートで保存

## 5. メリット

1. **数値計算の安定性**: 微小な数値誤差によるバグを防止
2. **メモリ効率**: 整数の方がメモリ使用量が少ない
3. **キャッシュ効率**: 同じ状態を確実に認識できる
4. **計算速度**: ハッシュ値計算や比較が高速

## 6. 実装箇所

- `parameters.py`: 変換関数群
- `state.py`: 整数レートベースの状態表現
- `dp.py`: 整数レートベースの期待値計算
- `simulation.py`: 整数レートベースのシミュレーション
- `result_cache.py`: 整数レートでの永続化 