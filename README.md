# 複数アカウントにおけるレートマッチング最適戦略

<p align="center">
  <img src="https://user-images.githubusercontent.com/placeholder/elo.png" width="400" alt="illustration"/>
</p>

本リポジトリでは、**複数アカウントを保有するプレイヤーが、限られた試合数でどのようにレート戦へ参加すれば最終レート（シーズン終了時に最も高いアカウントのレート）の期待値を最大化できるか**を、理論計算と数値シミュレーションの両面から解析します。

---

## 1. 背景と課題
多くのオンラインゲームでは Elo をベースにしたレーティングが用いられ、シーズン終了時の"瞬間レート"でランキングが決まります。複数アカウントを同時運用する場合、**最も高いレートを持つアカウントだけが順位に反映される**ため、

* どのタイミングでどのアカウントを出すべきか？
* 途中で"打ち止め"にして確定すべきか？

といった戦略が総合レートの期待値に影響します。本プロジェクトはこれを**動的計画法 (DP) による逐次最適化**で厳密に評価し、Monte-Carlo シミュレーションで検証します。

---

## 2. 解析モデル
1. レート変動: 1 試合ごとに固定値 $\pm 16$ 増減。
2. 勝率関数: 線形近似 $p(r)=0.5 - k (r - \mu)$。適正レート $\mu$ に収束するイメージ。
3. 各アカウントは同じ $\mu$ を共有し、初期レートから $N_0$ 試合で近傍に到達後、"揺らぎ"フェーズに入ると仮定。
4. 全アカウントの総試合数に上限 $N$ を設け、途中で打ち切ることも可能。
5. 終了時は最大レートを採用。

詳細な数式は `document/permanent/期待値逐次解法.md` を参照してください。

---

## 3. リポジトリ構成
```
├── document/
│   ├── fleeting/   # アイデアメモ（走り書き）
│   ├── ai/         # 実装計画など自動生成ドキュメント
│   └── permanent/  # 確定仕様・最終レポート
│
└── src/            # 実装コード
    ├── core/       # DP・数式処理
    ├── simulator/  # Monte-Carlo シミュレーション
    └── tests/      # pytest
```

---

## 4. 今後のロードマップ
- [ ] ドキュメント整備
  - [x] 下書き（fleeting）
  - [x] AI による清書（current）
  - [x] レビュー後 permanent へ昇格
- [x] 期待値 DP モジュール実装
- [x] シミュレーション実装
- [ ] 小規模ケースでの検証
- [ ] 大規模実験 & 可視化
- [ ] 考察・レポートまとめ

## 5. 計算結果の保存と再利用

DP 計算は試合数 `n` とアカウント数 `r` が増えるにつれ指数的に時間が掛かります。
そこで、本リポジトリでは**計算結果をディスクにキャッシュ**し、同じ条件を再度計算する場合に再利用します。

### 5.1 仕組み
1. `src/cli.py` の `dp` サブコマンド実行時、
   - まず `output/n{n}_acc{r}.txt` を探索し、該当するレート列があればその値を読み込みます (再計算しない)。
   - 無ければ通常通り DP を実行し、得られた期待値と最適アクションをファイルへ追記します。
2. これにより **一度計算した状態は永続的にキャッシュ** されるため、次回以降は即時に結果を取得できます。

### 5.2 出力ファイル形式
```
output/n100_acc3.txt
n=100
r=3

account1, account2, account3, expectation, best_action
1700, 1700, 1700, 1750, 1
1716, 1700, 1700, 1760, 1
1716, 1716, 1700, 1770, 1
```
* 先頭 2 行: パラメータ (`n`, `r`)
* 空行
* ヘッダ行
* 以降は `[アカウント毎のレート], 期待値, best_action` を CSV 形式で追記します。

### 5.3 使い方
```bash
# 例) 残り 20 試合、アカウント 3 つで全て 1500 スタートの場合
python -m src.cli dp --n 20 --accounts 3
```
初回は DP 計算を行い、2 回目以降はキャッシュが利用されます。

